<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title></title>
        <style>
            code {
                white-space: pre-line;
            }

            hr {
                color: #888;
                background-color: #888;
                margin-top: 15px;
            }

            table {
                margin: 5px;
            }

            /* #processInfo {
                border: 1px solid #888;
            } */

            #unlinkWebviewDiv {
                font-size: 14pt;
                padding: 5px;
                margin: 15px;
                border: 1px solid white;
            }

            .hiddenItem code {
                color: #888;
                font-style: italic;
            }

            .emptyItem code {
                color: rgb(167, 127, 67);
                font-style: italic;
            }

            .streamItem {
                /* border: 1px solid #888; */
                padding: 9px;
                border-bottom: 1px solid #999;
            }

            .header {
                font-size: 13pt;
                font-weight: bold;
            }

            .header-small {
                font-size: 11pt;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <!-- VUE.JS IMPORT - USE THE MINIFIED VERSION FOR PERFORMANCE IF POSSIBLE -->
        <!-- <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script> -->
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>

        <script>
            Vue.component('std-row', {
                props: ['title', 'ifempty', 'data', 'visible'],
                data: () => { 
                    return { 
                        data: '', 
                        visible: true 
                    }; 
                },
                computed: {
                    getText: function() {
                        if (!this.visible) 
                            return 'Hidden.';
                        else if (this.data === '')
                            return this.ifempty;
                        return this.data;
                    }
                },
                template: `
                <tr>
                    <td class="streamItem">
                        <span class="header-small">{{ title }}</span><br>
                        <a href="#invalid" v-on:click="() => visible = !visible">{{ visible ? 'Hide' : 'Show' }}</a>
                    </td>
                    <td class="streamItem" :class="{ hiddenItem: !visible, emptyItem: visible && data === '' }"><code>{{ getText }}</code></td>
                </tr>`
            });
        </script>

        <h1>Output of "${srcName}"</h1>
        
        <div id="compileError" v-if="data !== []">
            <h2>Compile Errors/Warnings</h2>
            <code v-for="error in data"><p>{{ error }}</p></code>
        </div>
        
        <div id="cases" v-if="visible">
            <div v-for="curCase in cases">
                <hr>
                <h2>Case #{{ curCase.id + 1 }}</h2>

                <table id="streamTable">
                    <std-row title="Input" ifempty="No Input." :data="curCase.stdin" :visible.once="curCase.stdin.length < 2000"></std-row>
                    <std-row title="Output" ifempty="No Output." :data="curCase.stdout" :visible.once="true"></std-row>
                    <std-row title="Errors" ifempty="No Errors." :data="curCase.stderr" :visible.once="true"></std-row>
                </table>
        
                <table id="processInfo">
                    <!-- <tr><td class="header">Info</td></tr> -->
                    <tr>
                        <td>Time Elapsed:</td>
                        <td><i>{{ curCase.time !== -1 ? curCase.time.toString() + 'ms' : 'Unknown' }}</i></td>
                    </tr>
                    <tr>
                        <td>Memory Usage:</td>
                        <td><i>{{ curCase.memory !== -1 ? (Math.round(curCase.memory / 1.024) / 1000).toString() + 'KB' : 'Negligible' }}</i></td>
                    </tr>
                    <tr v-if="curCase.exitInfo[0] !== ''">
                        <td>{{ curCase.exitInfo[0] }}</td>
                        <td><i>{{ curCase.exitInfo[1] }}</i></td>
                    </tr>
                    <tr><td>
                        <a href="#invalid" v-on:click="killProcess">Kill</a>
                    </tr></td>
                </table>
            </div>
        </div>

        <div id="unlinkWebviewDiv">
            <a href="#unlinkWebviewDiv" onclick="unlinkWebview()">Unlink Current Webview:</a>
            <span> If the <code>Reuse Webviews</code> option is set to true, clicking the link will no longer cause vscode to reuse this Webview for future build and run sessions</span>
        </div>

        <script>
            let caseCount = parseInt('${caseCount}'), srcName = '${srcName}', charLimit = parseInt('${charLimit}');
            const vscode = acquireVsCodeApi();
            
            const casesApp = new Vue({
                el: '#cases',
                data: {
                    visible: true,
                    cases: []
                },
                methods: {
                    toggleVar: function(id, key) {
                        this.cases[id][key] = !this.cases[id][key];
                    },
                    killProcess: () => vscode.postMessage('kill')
                }
            });
            
            const compileErrorApp = new Vue({
                el: '#compileError',
                data: {
                    data: []
                }
            });

            function unlinkWebview() {
                vscode.postMessage('unlink');
                document.getElementById('unlinkWebviewDiv').innerHTML += '<br><span style="font-size: 11pt; color: #777;"><i>Unlinked current webview!</i></span>';
            }

            function reset() {
                document.getElementsByName('title').forEach(ele => ele.innerHTML = `Output of "${srcName}"`);
                compileErrorApp.data = [];
                casesApp.visible = true;
                casesApp.cases.length = 0;

                for (var i = 0; i < caseCount; i++) {
                    casesApp.cases.push({
                        id: i,
                        visible: true,
                        stdin: '',
                        stdout: '',
                        stderr: '',
                        time: -1,
                        memory: -1,
                        exitInfo: ['', '']
                    });
                }
            }

            reset();
            
            window.addEventListener('message', event_ => {
                const event = event_.data, type = event.type, caseNo = event.caseNo, curCase = casesApp.cases[caseNo];
                // console.log(`Event: ${JSON.stringify(event)}`);
                
                if (type == 'compilerError') {
                    compileErrorApp.data.push(event.data);
                    if (event.fatal) {
                        casesApp.visible = false;
                    }
                }
                else if (type == 'beginCase') {
                    curCase.stdin = event.input;
                }
                else if (type == 'updateTime') {
                    curCase.time = Math.max(curCase.time, event.newElapsed);
                }
                else if (type == 'updateMemory') {
                    curCase.memory = event.newMemory;
                }
                else if (type == 'updateStdout') {
                    // console.log(event.data.toString());
                    if (curCase.stdout.length < charLimit) {
                        curCase.stdout += event.data;
                        if (curCase.stdout.length > charLimit)
                            curCase.stdout = curCase.stdout.substr(0, charLimit) + '\n[Truncated]';
                    }
                }
                else if (type == 'updateStderr') {
                    if (curCase.stderr.length < charLimit) {
                        curCase.stderr += event.data;
                        if (curCase.stderr.length > charLimit)
                            curCase.stderr = curCase.stderr.substr(0, charLimit) + '\n[Truncated]';
                    }
                }
                else if (type == 'end') {
                    curCase.exitInfo = event.endMsg;
                }
            });

            // When ready
            vscode.postMessage('ready');
        </script>
    </body>
</html>